<!DOCTYPE html>
<html>
<head>
    <title>Test Human Takeover</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; }
        button { padding: 10px 20px; margin: 10px; background: #007bff; color: white; border: none; cursor: pointer; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 4px solid #007bff; }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        #messages { height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
        .message { margin: 5px 0; padding: 5px; border-radius: 5px; }
        .user-message { background: #e3f2fd; }
        .agent-message { background: #e8f5e8; }
        .human-agent-message { background: #fff3cd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Human Takeover Functionality</h1>
        
        <div class="test-section">
            <h2>1. Widget Configuration</h2>
            <p>Widget Key: <span id="widget-key">demowidget</span></p>
            <p>Session ID: <span id="session-id">test-session-123</span></p>
            <button onclick="loadWidget()">Load Widget</button>
            <div id="widget-container"></div>
        </div>
        
        <div class="test-section">
            <h2>2. WebSocket Connection</h2>
            <button onclick="connectWebSocket()">Connect WebSocket</button>
            <button onclick="disconnectWebSocket()">Disconnect</button>
            <div id="ws-status" class="log">Not connected</div>
        </div>
        
        <div class="test-section">
            <h2>3. Message Testing</h2>
            <input type="text" id="test-message" placeholder="Enter test message" style="width: 300px; padding: 5px;">
            <button onclick="sendTestMessage()">Send Test Message</button>
            <div id="messages"></div>
        </div>
        
        <div class="test-section">
            <h2>4. Human Takeover Test</h2>
            <p>Simulating human agent message from Agent Console...</p>
            <button onclick="simulateHumanTakeover()">Simulate Human Takeover</button>
            <div id="takeover-logs"></div>
        </div>
    </div>
    
    <script>
        const widgetKey = 'demowidget';
        const sessionId = 'test-session-123';
        let ws = null;
        
        function log(message, type = 'info') {
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.textContent = new Date().toLocaleTimeString() + ': ' + message;
            document.getElementById('takeover-logs').appendChild(logDiv);
        }
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                document.getElementById('ws-status').textContent = 'Connected to WebSocket';
                document.getElementById('ws-status').className = 'log success';
                log('WebSocket connected', 'success');
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                log(`WebSocket message: ${JSON.stringify(data)}`);
                
                if (data.type === 'human_agent_message') {
                    const messagesDiv = document.getElementById('messages');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message human-agent-message';
                    messageDiv.innerHTML = `
                        <strong>Human Agent (${data.message.humanAgentName || 'Unknown'}):</strong><br>
                        ${data.message.content}
                    `;
                    messagesDiv.appendChild(messageDiv);
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            };
            
            ws.onclose = () => {
                document.getElementById('ws-status').textContent = 'Disconnected from WebSocket';
                document.getElementById('ws-status').className = 'log error';
                log('WebSocket disconnected', 'error');
            };
            
            ws.onerror = (error) => {
                log(`WebSocket error: ${error}`, 'error');
            };
        }
        
        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        function sendTestMessage() {
            const message = document.getElementById('test-message').value;
            if (!message) return;
            
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            messageDiv.innerHTML = `<strong>User:</strong> ${message}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            document.getElementById('test-message').value = '';
        }
        
        function simulateHumanTakeover() {
            log('Simulating human takeover message...');
            
            // Simulate what Agent Console would send
            const humanMessage = {
                type: 'human_agent_message',
                channelType: 'web',
                channelId: widgetKey,
                userId: sessionId,
                agentId: 1,
                message: {
                    messageType: 'agent',
                    content: 'Hello! I am a human agent taking over this conversation. How can I help you?',
                    timestamp: new Date().toISOString(),
                    humanAgent: true,
                    humanAgentName: 'Test Agent'
                }
            };
            
            // Send via WebSocket if connected
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(humanMessage));
                log('Sent human takeover message via WebSocket', 'success');
            } else {
                log('WebSocket not connected', 'error');
            }
        }
        
        function loadWidget() {
            const widgetContainer = document.getElementById('widget-container');
            widgetContainer.innerHTML = `
                <script src="/widget/embed.js?widgetKey=${widgetKey}"></script>
                <div style="margin-top: 10px;">
                    <em>Widget loaded with key: ${widgetKey}</em>
                </div>
            `;
        }
        
        // Auto-connect on page load
        document.addEventListener('DOMContentLoaded', function() {
            connectWebSocket();
        });
    </script>
</body>
</html>